---
title: "control_plot_albedo_processing"
author: "Erika Lee"
date: "2024-06-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#packages
library(tidyverse)
library(lubridate)
library(ggplot2)
library(stringr)
library(readxl)
library(rstatix)
library(sf)
library(terra)
library(plotly)
library(RColorBrewer) 
library(plotly)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

```{r}
#read in persistent control plot data
pers_control_all <- read_excel("nsf/albedo/albedo_experimental_plots/pers_experimental_plots.xlsx") %>%
  # Convert Date to the correct date format
  mutate(date = ymd(date))%>%
  # Ensure Time is formatted correctly (remove any weird date part)
  mutate(time = format(as.POSIXct(time, format = "%H:%M:%S"), format = "%H:%M:%S")) %>%
  mutate(datetime = ymd_hms(paste(date, time))) %>%
  select(c(site_name, concentration, id, date, time, datetime, everything()))

#read in transitional control plots
trans_control_all <- read_excel("nsf/albedo/albedo_experimental_plots/trans_experimental_plots.xlsx") %>%
  # Convert Date to the correct date format
  mutate(date = ymd(date)) %>%
  # Ensure Time is formatted correctly (remove any weird date part)
  mutate(time = format(as.POSIXct(time, format = "%H:%M:%S"), format = "%H:%M:%S")) %>%
  mutate(datetime = ymd_hms(paste(date, time))) %>%
  select(c(site_name, concentration, id, date, time, datetime, everything()))
```

```{r}
#plotting albedo for control plots

##this plot does not really make sense yet, may need to mess around with what is being facet wrapped + the concentration column
pers_control_snow_albedo_all_plot <- ggplot(data = pers_control_all) +
  geom_bar(aes(x = id, y = albedo, fill = soot_mass_g), alpha = 0.7, position = "dodge") +
  labs(
    title = "Persistent Control Plot Albedo Data",
    x = "Site Name",
    y = "Albedo (unitless)", 
    fill = "Soot Mass Added (g)"
  ) +
  theme_minimal() +
  facet_wrap(~concentration + date)
  
pers_control_snow_albedo_all_plot

# Define a custom vector of colors from the "Spectral" palette
custom_colors <- brewer.pal(11, "Spectral")[1:3]

V2_pers_control_albedo_all_plot <- ggplot(data = pers_control_all) +
  geom_bar(aes(x = id, y = albedo, fill = concentration), alpha = 0.9, position = "dodge", stat = "identity") +
  labs(
    title = "Persistent Control Plot Albedo Data",
    x = "Site Name",
    y = "Albedo (unitless)", 
    fill = "Concentration of Soot Added"
  ) +
  theme_minimal() +
  facet_wrap(~date) +
  scale_fill_manual(values = custom_colors)
  
V2_pers_control_albedo_all_plot

# Convert ggplot to Plotly plot
pers_control_albedo_plotly <- ggplotly(V2_pers_control_albedo_all_plot)

pers_control_albedo_plotly

#creating a snow depth plot for the same information, but instead of albedo doing snow depth
## Define a custom vector of colors from the "Spectral" palette
custom_colors_2 <- brewer.pal(11, "BrBG")[10:8]

pers_control_snowd_all_plot <- ggplot(data = pers_control_all) +
  geom_bar(aes(x = id, y = snow_depth_cm, fill = concentration), alpha = 0.9, position = "dodge", stat = "identity") +
  labs(
    title = "Persistent Control Plot Snow Depth Data",
    x = "Site Name",
    y = "Snow Depth (cm)", 
    fill = "Concentration of Soot Added"
  ) +
  theme_minimal() +
  facet_wrap(~date) +
  scale_fill_manual(values = custom_colors_2)

pers_control_snowd_all_plot

# Convert ggplot to Plotly plot
pers_control_snowd_all_plotly <- ggplotly(pers_control_snowd_all_plot)

pers_control_snowd_all_plotly

#trying to combine ggplots and export to see if the layout works - it does, they are just not interactive
pers_b_control_all_V2 <- V2_pers_control_albedo_all_plot + pers_control_snowd_all_plot + plot_layout(nrow = 2)

print(pers_b_control_all_V2)

#combining albedo and snow depth plots - NOT WORKING
pers_b_control_allplots <- subplot(pers_control_albedo_plotly, pers_control_snowd_all_plotly, nrows = 2, shareX = TRUE)

# Add individual y-axis titles - NOT WORKING
pers_b_control_allplots <- layout(pers_b_control_allplots,
                                  title = list(text = "Persistent Control Plots Albedo and Snow Depth"),
                                  xaxis = list(title = "Plot Name"), 
                                  yaxis = list(title = "Albedo (unitless)"), 
                                  yaxis2 = list(title = "Snow Depth (cm)"))

pers_b_control_allplots
```

Transitional Plots

```{r}

trans_control_albedo_all_plot <- ggplot(data = trans_control_all) +
  geom_bar(aes(x = id, y = albedo, fill = concentration), alpha = 0.9, position = "dodge", stat = "identity") +
  labs(
    title = "Transitional Control Plot Albedo Data",
    x = "Site Name",
    y = "Albedo (unitless)", 
    fill = "Concentration of Soot Added"
  ) +
  theme_minimal() +
  facet_wrap(~date) +
  scale_fill_manual(values = custom_colors)
  
trans_control_albedo_all_plot

# Convert ggplot to Plotly plot
trans_control_albedo_plotly <- ggplotly(trans_control_albedo_all_plot)

trans_control_albedo_plotly

#creating a snow depth plot for the same information, but instead of albedo doing snow depth
## Define a custom vector of colors from the "Spectral" palette
custom_colors_2 <- brewer.pal(11, "BrBG")[10:8]

trans_control_snowd_all_plot <- ggplot(data = trans_control_all) +
  geom_bar(aes(x = id, y = snow_depth_cm, fill = concentration), alpha = 0.9, position = "dodge", stat = "identity") +
  labs(
    title = "Transitional Control Plot Snow Depth Data",
    x = "Site Name",
    y = "Snow Depth (cm)", 
    fill = "Concentration of Soot Added"
  ) +
  theme_minimal() +
  facet_wrap(~date) +
  scale_fill_manual(values = custom_colors_2)

trans_control_snowd_all_plot

#Combining ggplots and export to see if the layout works - it does, they are just not interactive
trans_b_control_all <- trans_control_albedo_all_plot + trans_control_snowd_all_plot + plot_layout(nrow = 2)

print(trans_b_control_all)

print(pers_b_control_all_V2)

# Convert ggplot to Plotly plot - NOT WORKING
trans_control_snowd_all_plotly <- ggplotly(trans_control_snowd_all_plot)

trans_control_snowd_all_plotly

#combining albedo and snow depth plots - NOT WORKING
trans_b_control_allplots <- subplot(trans_control_albedo_plotly, trans_control_snowd_all_plotly, nrows = 2, shareX = TRUE) 

trans_b_control_allplots <- trans_b_control_allplots %>%
  layout(trans_b_control_allplots,
                                   title = list(text = "Transitional Control Plots Albedo and Snow Depth"),
                                   xaxis = list(title = "Plot Name"),
                                   yaxis = list(title = "Albedo (unitless)"),  # Adjust domain for y-axis 1
                                   yaxis2 = list(title = "Snow Depth (cm)"))

trans_b_control_allplots
```

```{r}
#exporting individual plots because I cannot get the combination plots to work well

##persistent plots
# Save the plot as a PNG file to working directory
ggsave("pers_b_control_all.png", plot = pers_b_control_all_V2, width = 8, height = 6, dpi = 300, bg = "white")

ggsave("trans_b_control_all.png", plot = trans_b_control_all, width = 8, height = 6, dpi = 300, bg = "white")

print(trans_b_control_all)

print(pers_b_control_all_V2)
```
